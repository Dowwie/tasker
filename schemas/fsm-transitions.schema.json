{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "FSMTransitions",
  "description": "Transition definitions for a single state machine. Links behaviors to state changes. CANONICAL: JSON is the source of truth; Mermaid diagrams are derived.",
  "type": "object",
  "required": ["version", "machine_id", "transitions"],
  "definitions": {
    "spec_ref": {
      "description": "Reference to source spec content for traceability (MANDATORY for provenance)",
      "type": "object",
      "required": ["quote"],
      "properties": {
        "quote": {
          "type": "string",
          "minLength": 5,
          "description": "Verbatim text from workflow variant/failure"
        },
        "location": {
          "type": "string",
          "description": "Section reference (e.g., 'Workflow 1, Variant 2')"
        }
      }
    },
    "guard": {
      "type": "object",
      "required": ["condition", "invariant_id"],
      "description": "Condition that must hold for transition to fire. MUST link to invariant per I4.",
      "properties": {
        "condition": {
          "type": "string",
          "minLength": 3,
          "description": "Human-readable guard condition"
        },
        "invariant_id": {
          "type": "string",
          "minLength": 1,
          "description": "REQUIRED: Link to spec invariant that this guard enforces"
        },
        "negated": {
          "type": "boolean",
          "default": false,
          "description": "True if this guard checks for condition NOT holding"
        }
      }
    },
    "failure_outcome": {
      "type": "object",
      "required": ["condition"],
      "description": "What happens when a transition fails or guard is not satisfied",
      "properties": {
        "condition": {
          "type": "string",
          "minLength": 3,
          "description": "Condition that triggers this failure outcome"
        },
        "to_state": {
          "type": "string",
          "pattern": "^S[0-9]+$",
          "description": "Target failure state (mutually exclusive with terminal)"
        },
        "terminal": {
          "type": "boolean",
          "description": "True if this failure terminates the flow (mutually exclusive with to_state)"
        },
        "notes": {
          "type": "string",
          "description": "Additional context about this failure case"
        }
      }
    },
    "trigger": {
      "type": "object",
      "description": "Structured trigger definition (preferred over string)",
      "required": ["type", "name"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["event", "action", "timeout", "condition"],
          "description": "Category of trigger"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Trigger identifier"
        }
      }
    }
  },
  "properties": {
    "version": {
      "const": "1.0"
    },
    "machine_id": {
      "type": "string",
      "pattern": "^M[0-9]+$",
      "description": "Reference to parent machine in index"
    },
    "transitions": {
      "type": "array",
      "minItems": 1,
      "description": "All transitions in this machine",
      "items": {
        "type": "object",
        "required": ["id", "from_state", "to_state", "trigger", "spec_ref"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^TR[0-9]+$",
            "description": "Transition ID (TR1, TR2, etc.)"
          },
          "from_state": {
            "type": "string",
            "pattern": "^S[0-9]+$",
            "description": "Source state ID"
          },
          "to_state": {
            "type": "string",
            "pattern": "^S[0-9]+$",
            "description": "Target state ID"
          },
          "trigger": {
            "oneOf": [
              {
                "type": "string",
                "minLength": 1,
                "description": "Simple trigger string (legacy support)"
              },
              {
                "$ref": "#/definitions/trigger",
                "description": "Structured trigger (preferred)"
              }
            ],
            "description": "Event or action that triggers this transition"
          },
          "guards": {
            "type": "array",
            "items": {
              "$ref": "#/definitions/guard"
            },
            "description": "Conditions that must hold for transition (all must be satisfied). Guards MUST link to invariants."
          },
          "failure_outcomes": {
            "type": "array",
            "items": {
              "$ref": "#/definitions/failure_outcome"
            },
            "description": "What happens when guards fail or transition cannot complete. Empty array explicitly means 'not applicable'."
          },
          "behaviors": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^B[0-9]+$"
            },
            "description": "Behavior IDs executed during this transition"
          },
          "actions": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Actions to perform during transition"
          },
          "spec_ref": {
            "$ref": "#/definitions/spec_ref",
            "description": "REQUIRED: Source spec content that defined this transition (prevents FSM hallucination)"
          },
          "is_failure_path": {
            "type": "boolean",
            "default": false,
            "description": "True if this handles an error/failure condition"
          },
          "priority": {
            "type": "integer",
            "minimum": 1,
            "description": "Evaluation priority when multiple transitions from same state (lower = first)"
          }
        }
      }
    },
    "guards_index": {
      "type": "object",
      "description": "Invariant ID -> transition IDs that use it as guard (for coverage validation)",
      "additionalProperties": {
        "type": "array",
        "items": {
          "type": "string",
          "pattern": "^TR[0-9]+$"
        }
      }
    }
  }
}
